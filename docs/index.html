<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AyurAssist ‚Äî AI-Powered Ayurveda Clinical Decision Support</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
:root{--bg-cream:#F7F3ED;--bg-warm:#EDE8DF;--bg-card:#FFF;--green-deep:#2D5016;--green-mid:#4A7C28;--green-soft:#6B9B3A;--green-light:#E8F0DE;--green-glow:#A4C639;--amber:#D4A017;--amber-soft:#FFF3D0;--terra:#8B4513;--terra-soft:#F5E6D3;--red-warn:#C0392B;--red-soft:#FDEDEB;--blue-soft:#E3F2FD;--text-dark:#1A1A1A;--text-mid:#4A4A4A;--text-light:#7A7A7A;--border:#E0D8CC;--shadow-sm:0 1px 3px rgba(0,0,0,.06);--shadow-md:0 4px 16px rgba(0,0,0,.08);--r-sm:8px;--r-md:12px;--r-lg:20px;--r-xl:28px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg-cream);color:var(--text-dark);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(circle at 15% 20%,rgba(74,124,40,.04) 0%,transparent 50%),radial-gradient(circle at 85% 80%,rgba(212,160,23,.04) 0%,transparent 50%);pointer-events:none;z-index:0}
.app{max-width:920px;margin:0 auto;padding:24px 20px 60px;position:relative;z-index:1}
.hidden{display:none!important}
.header{text-align:center;padding:48px 0 36px}
.header-badge{display:inline-flex;align-items:center;gap:6px;background:var(--green-light);color:var(--green-deep);font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;padding:6px 16px;border-radius:100px;margin-bottom:16px}
.header h1{font-family:'Fraunces',serif;font-size:44px;font-weight:700;color:var(--green-deep);letter-spacing:-1px}
.header h1 span{color:var(--green-soft);font-weight:300;font-style:italic}
.header-sub{font-size:15px;color:var(--text-light);margin-top:8px}
.header-div{width:60px;height:3px;background:linear-gradient(90deg,var(--green-soft),var(--amber));margin:20px auto 0;border-radius:2px}
.search-section{background:var(--bg-card);border-radius:var(--r-xl);padding:32px;box-shadow:var(--shadow-md);border:1px solid var(--border);margin-bottom:28px}
.search-label{font-family:'Fraunces',serif;font-size:20px;font-weight:500;margin-bottom:4px}
.search-hint{font-size:13px;color:var(--text-light);margin-bottom:16px}
.examples{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.example-btn{padding:8px 16px;background:var(--green-light);color:var(--green-deep);border:none;border-radius:20px;font-size:14px;cursor:pointer;transition:.2s;font-family:inherit}
.example-btn:hover{background:var(--green-mid);color:#fff}
.search-bar{display:flex;gap:10px}
.search-input{flex:1;padding:14px 20px;font-size:16px;font-family:inherit;border:2px solid var(--border);border-radius:var(--r-md);background:var(--bg-cream);color:var(--text-dark);outline:none;transition:.25s}
.search-input:focus{border-color:var(--green-mid);background:#fff;box-shadow:0 0 0 4px rgba(74,124,40,.1)}
.search-btn{padding:14px 28px;background:linear-gradient(135deg,var(--green-deep),var(--green-mid));color:#fff;border:none;border-radius:var(--r-md);font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.25s;white-space:nowrap}
.search-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(45,80,22,.3)}
.search-btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.loading{margin-top:16px;padding:20px;text-align:center;font-size:14px;color:var(--text-light);background:var(--bg-card);border-radius:var(--r-md);border:1px solid var(--border)}
.error-alert{margin-top:16px;padding:12px 16px;background:var(--red-soft);color:var(--red-warn);border-radius:var(--r-sm);font-size:13px;border-left:4px solid var(--red-warn)}
.ner-strip{display:flex;align-items:center;gap:8px;padding:12px 20px;background:var(--green-light);border-radius:var(--r-md);margin-bottom:20px;flex-wrap:wrap}
.ner-strip-label{font-size:12px;font-weight:600;color:var(--green-deep);text-transform:uppercase;letter-spacing:.8px}
.ner-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;background:#fff;border:1px solid rgba(74,124,40,.2);border-radius:100px;font-size:13px;font-weight:500;color:var(--green-deep)}
.ner-tag .score{font-size:11px;color:var(--text-light);font-weight:400}
.match-banner{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(135deg,var(--green-deep),var(--green-mid));border-radius:var(--r-md);margin-bottom:20px;color:#fff}
.match-banner-left{display:flex;align-items:center;gap:10px}
.match-icon{width:36px;height:36px;background:rgba(255,255,255,.15);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
.match-text h3{font-size:16px;font-weight:600}.match-text p{font-size:12px;opacity:.8}
.match-percent{font-family:'Fraunces',serif;font-size:28px;font-weight:700;color:var(--green-glow)}
.disease-header{background:var(--bg-card);border-radius:var(--r-lg);padding:28px;box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:16px}
.ita-code{display:inline-block;font-size:11px;font-weight:600;color:var(--amber);background:var(--amber-soft);padding:3px 10px;border-radius:100px;letter-spacing:.5px;margin-bottom:10px}
.disease-header h2{font-family:'Fraunces',serif;font-size:30px;font-weight:700;color:var(--green-deep);line-height:1.2}
.disease-header .sanskrit{font-family:'Fraunces',serif;font-size:17px;font-style:italic;color:var(--terra);margin-top:2px}
.dosha-line{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.dosha-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dosha-dot.vata{background:#5B8DEF}.dosha-dot.pitta{background:#FF7043}.dosha-dot.kapha{background:#4CAF50}
.dosha-text{font-size:14px;color:var(--text-mid);font-weight:500}
.snomed-row{display:flex;align-items:center;gap:8px;margin-top:10px;font-size:13px;color:var(--text-light)}
.snomed-code{font-family:monospace;background:var(--bg-warm);padding:2px 8px;border-radius:4px;font-size:12px;font-weight:600;color:var(--text-mid)}
.sc{background:var(--bg-card);border-radius:var(--r-lg);padding:24px;box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:12px}
.sc-head{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.sc-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.sc-icon.green{background:var(--green-light)}.sc-icon.amber{background:var(--amber-soft)}.sc-icon.terra{background:var(--terra-soft)}.sc-icon.red{background:var(--red-soft)}.sc-icon.blue{background:var(--blue-soft)}
.sc-title{font-family:'Fraunces',serif;font-size:18px;font-weight:600;color:var(--text-dark)}
.desc-text{font-size:15px;line-height:1.65;color:var(--text-mid)}
.fmt-h3{display:block;font-family:'Fraunces',serif;font-size:15px;font-weight:700;color:var(--green-deep);margin:14px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--green-light)}
.fmt-h3:first-child{margin-top:0}
.fmt-h2{display:block;font-family:'Fraunces',serif;font-size:17px;font-weight:700;color:var(--green-deep);margin:16px 0 8px}
.fmt-hr{border:none;border-top:1px solid var(--border);margin:10px 0}
.fmt-bullet{display:flex;align-items:flex-start;gap:8px;padding:3px 0;font-size:14px;color:var(--text-mid);line-height:1.55}
.fmt-bullet-dot{color:var(--green-mid);font-weight:700;flex-shrink:0;margin-top:1px}
.fmt-bold{font-weight:600;color:var(--text-dark)}
.fmt-em{font-style:italic;color:var(--terra)}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.tag-list{display:flex;flex-wrap:wrap;gap:8px}
.tag-nidana{padding:6px 14px;background:var(--bg-cream);border:1px solid var(--border);border-radius:100px;font-size:13px;color:var(--text-mid)}
.tag-symptom{padding:6px 14px;background:#FFF8F0;border:1px solid #F0D8B8;border-radius:100px;font-size:13px;color:var(--terra)}
.remedy-grid{display:grid;gap:12px}
.remedy-card{background:var(--bg-cream);border:1px solid var(--border);border-radius:var(--r-md);padding:20px;transition:.2s}
.remedy-card:hover{border-color:var(--green-soft);box-shadow:var(--shadow-sm)}
.remedy-name{font-weight:700;font-size:16px;color:var(--green-deep);margin-bottom:2px}
.remedy-sanskrit{font-family:'Fraunces',serif;font-style:italic;font-size:13px;color:var(--terra);margin-bottom:12px}
.remedy-fields{display:grid;grid-template-columns:1fr 1fr;gap:10px 20px;margin-top:10px}
.rf{font-size:13px;color:var(--text-mid)}.rf-label{display:block;font-size:11px;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.form-card{background:var(--bg-cream);border:1px solid var(--border);border-radius:var(--r-md);padding:20px}
.form-card h4{font-family:'Fraunces',serif;font-size:16px;font-weight:600;color:var(--green-deep);margin-bottom:8px}
.form-desc{font-size:13px;color:var(--text-mid);line-height:1.6;margin-bottom:8px}
.form-meta{display:flex;gap:12px;font-size:12px;color:var(--text-mid);flex-wrap:wrap}
.form-meta span{display:inline-flex;align-items:center;gap:4px;background:var(--bg-warm);padding:3px 10px;border-radius:100px}
.ref-badge{font-size:11px;padding:2px 8px;background:var(--amber-soft);border-radius:4px;color:var(--amber);font-weight:600;margin-top:6px;display:inline-block}
.pk-card{padding:16px;background:var(--bg-cream);border:1px solid var(--border);border-radius:var(--r-md);border-left:3px solid var(--amber)}
.pk-card h4{font-size:15px;font-weight:600;color:var(--text-dark);margin-bottom:4px}.pk-card p{font-size:13px;color:var(--text-mid);line-height:1.5}
.diet-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.diet-col h4{font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.diet-col.favor h4{color:var(--green-mid)}.diet-col.avoid h4{color:var(--red-warn)}
.diet-tags{display:flex;flex-wrap:wrap;gap:6px}
.diet-tag{padding:4px 10px;border-radius:100px;font-size:12px;font-weight:500}
.diet-tag.good{background:var(--green-light);color:var(--green-deep)}.diet-tag.bad{background:var(--red-soft);color:var(--red-warn)}
.diet-note{grid-column:1/-1;padding:10px 14px;background:var(--amber-soft);border-radius:var(--r-sm);font-size:13px;color:var(--terra);line-height:1.5;border-left:3px solid var(--amber)}
.ls-list{list-style:none;display:flex;flex-direction:column;gap:6px}
.ls-list li{display:flex;align-items:flex-start;gap:8px;font-size:14px;color:var(--text-mid);padding:6px 0}
.ls-list li::before{content:'\25B8';color:var(--green-soft);font-weight:700;flex-shrink:0}
.yoga-grid{display:flex;flex-wrap:wrap;gap:8px}
.yoga-tag{padding:8px 16px;background:linear-gradient(135deg,#F0F7E8,#E8F0DE);border:1px solid rgba(74,124,40,.15);border-radius:var(--r-sm);font-size:13px;color:var(--green-deep);font-weight:500}
.prog-box{padding:16px 20px;background:linear-gradient(135deg,var(--green-light),#F0F7E8);border-radius:var(--r-md);font-size:14px;color:var(--text-mid);line-height:1.6}
.scroll-box{max-height:320px;overflow-y:auto;padding-right:4px;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.scroll-box::-webkit-scrollbar{width:6px}
.scroll-box::-webkit-scrollbar-track{background:transparent}
.scroll-box::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.scroll-box::-webkit-scrollbar-thumb:hover{background:var(--text-light)}
.warn-list{display:flex;flex-direction:column;gap:8px}
.warn-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--red-soft);border-radius:var(--r-sm);font-size:13px;color:var(--red-warn);font-weight:500}
.warn-icon{width:20px;height:20px;background:var(--red-warn);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.diff-card{padding:14px 18px;background:var(--bg-cream);border:1px solid var(--border);border-radius:var(--r-md);border-left:3px solid #5B8DEF}
.diff-card p{font-size:13px;color:var(--text-mid);line-height:1.5}
.modern-section{font-size:14px;color:var(--text-mid);line-height:1.7}
.modern-section .modern-sub{font-weight:600;color:var(--text-dark);font-size:14px;margin:14px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.modern-section .modern-sub:first-child{margin-top:0}
.modern-section ul{list-style:none;padding:0;margin:6px 0 0}
.modern-section ul li{padding:5px 0 5px 20px;position:relative;font-size:13px;line-height:1.5}
.modern-section ul li::before{content:'\2022';position:absolute;left:4px;color:var(--green-mid);font-weight:700}
.disclaimer{margin-top:20px;padding:16px 20px;background:var(--bg-warm);border-radius:var(--r-md);font-size:13px;color:var(--text-light);text-align:center;line-height:1.5;border:1px solid var(--border)}
.pipeline-flow{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:20px;padding:16px 0 4px;flex-wrap:wrap}
.pipe-step{display:flex;flex-direction:column;align-items:center;gap:4px}
.pipe-icon{font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--bg-warm);border-radius:10px}
.pipe-step span{font-size:11px;font-weight:500;color:var(--text-mid);white-space:nowrap}
.pipe-arrow{font-size:16px;color:var(--green-soft);font-weight:700;margin:0 2px;align-self:center;margin-bottom:16px}
.pipeline-tagline{text-align:center;font-size:12px;color:var(--text-light);margin-top:8px;font-style:italic}
.pipeline-tagline strong{color:var(--green-deep)}
.invest-card{padding:14px 18px;background:var(--bg-cream);border:1px solid var(--border);border-radius:var(--r-md);border-left:3px solid var(--amber)}
.invest-card p{font-size:13px;color:var(--text-mid);line-height:1.5}
.invest-grid{display:flex;flex-direction:column;gap:8px}
.invest-item{padding:12px 16px;background:var(--bg-cream);border:1px solid var(--border);border-radius:var(--r-sm);border-left:3px solid var(--amber)}
.invest-name{font-size:14px;font-weight:600;color:var(--text-dark);margin-bottom:2px}
.invest-finding{font-size:13px;color:var(--text-mid);line-height:1.5}
.dd-grid{display:flex;flex-direction:column;gap:8px}
.dd-item{padding:12px 16px;background:var(--bg-cream);border:1px solid var(--border);border-radius:var(--r-sm);border-left:3px solid #5B8DEF}
.dd-name{font-size:14px;font-weight:600;color:var(--text-dark);margin-bottom:2px}
.dd-detail{font-size:13px;color:var(--text-mid);line-height:1.5}
.prev-card{padding:14px 18px;background:linear-gradient(135deg,var(--green-light),#F0F7E8);border:1px solid rgba(74,124,40,.15);border-radius:var(--r-md);border-left:3px solid var(--green-mid)}
.prev-card p{font-size:14px;color:var(--text-mid);line-height:1.65}
.psy-card{padding:14px 18px;background:linear-gradient(135deg,var(--blue-soft),#F0F4FF);border:1px solid rgba(91,141,239,.15);border-radius:var(--r-md);border-left:3px solid #5B8DEF}
.psy-card p{font-size:14px;color:var(--text-mid);line-height:1.65}
.fade-in{animation:fadeUp .5s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:640px){.two-col,.diet-grid,.remedy-fields{grid-template-columns:1fr}.header h1{font-size:32px}.disease-header h2{font-size:24px}.search-bar{flex-direction:column}.app{padding:16px 12px 40px}}
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="header-badge">üåø WHO ITA Standards ¬∑ SNOMED CT Mapped</div>
    <h1>Ayur<span>Assist</span></h1>
    <p class="header-sub">AI-Powered Ayurveda Clinical Decision Support</p>
    <div class="header-div"></div>
  </header>
  <section class="search-section">
    <p class="search-label">Describe your symptoms</p>
    <p class="search-hint">Enter symptoms in plain language ‚Äî our NLP engine will identify medical entities</p>
    <div class="examples" id="examples">
      <button class="example-btn" data-value="cough">cough</button>
      <button class="example-btn" data-value="headache">headache</button>
      <button class="example-btn" data-value="stomach pain">stomach pain</button>
      <button class="example-btn" data-value="fever">fever</button>
      <button class="example-btn" data-value="loss of appetite">loss of appetite</button>
      <button class="example-btn" data-value="joint pain">joint pain</button>
      <button class="example-btn" data-value="skin rash">skin rash</button>
    </div>
    <div class="search-bar">
      <input class="search-input" id="symptomInput" type="text" placeholder="e.g., I have severe cough with phlegm" autocomplete="off">
      <button class="search-btn" id="analyzeBtn" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Analyze
      </button>
    </div>
    <div class="pipeline-flow">
      <div class="pipe-step"><div class="pipe-icon">üí¨</div><span>Symptom Input</span></div>
      <div class="pipe-arrow">‚Üí</div>
      <div class="pipe-step"><div class="pipe-icon">üß†</div><span>Biomedical NER</span></div>
      <div class="pipe-arrow">‚Üí</div>
      <div class="pipe-step"><div class="pipe-icon">üîó</div><span>UMLS + WHO ITA</span></div>
      <div class="pipe-arrow">‚Üí</div>
      <div class="pipe-step"><div class="pipe-icon">üè•</div><span>SNOMED CT</span></div>
      <div class="pipe-arrow">‚Üí</div>
      <div class="pipe-step"><div class="pipe-icon">üåø</div><span>QWEN 3-32B</span></div>
    </div>
    <p class="pipeline-tagline"><em>"Because Ayurveda deserves global interoperability"</em> ‚Äî <strong>KV</strong></p>
  </section>
  <div id="loading" class="loading hidden"><p>üîÑ AI is analyzing your symptoms... This may take 30‚Äì90s</p></div>
  <div id="error" class="error-alert hidden"></div>
  <div id="nerStrip" class="ner-strip hidden"><span class="ner-strip-label">Detected Entities</span></div>
  <div id="matchBanner" class="match-banner hidden">
    <div class="match-banner-left"><div class="match-icon">‚úì</div><div class="match-text"><h3>Ayurvedic Match Found</h3><p id="matchDetails"></p></div></div>
    <div class="match-percent" id="matchPercent">100%</div>
  </div>
  <div id="diseaseHeader" class="disease-header hidden">
    <span class="ita-code" id="itaCode">ITA</span>
    <h2 id="diseaseName"></h2>
    <p class="sanskrit" id="sanskritName"></p>
    <div class="dosha-line" id="doshaLine"></div>
    <div class="snomed-row" id="snomedRow"><span>SNOMED CT:</span><span class="snomed-code" id="snomedCode"></span><span id="snomedName"></span></div>
    <div class="snomed-row" id="icdRow" style="display:none"><span>ICD-10:</span><span class="snomed-code" id="icdCode" style="background:#E3F2FD;color:#1565C0"></span></div>
  </div>
  <div id="results" class="hidden"></div>
  <div id="disclaimerFooter" class="disclaimer hidden">
    ‚öïÔ∏è This information is for <strong>educational purposes only</strong>. Always consult a qualified Ayurvedic practitioner before starting any treatment.
    <br><span style="font-size:11px;margin-top:4px;display:inline-block">AyurAssist v7.4 ¬∑ NLP + LLM ¬∑ WHO ITA ¬∑ SNOMED CT ¬∑ ICD-10</span>
  </div>
</div>
<script>
/* AyurAssist v7.4 ‚Äî Fixed parseRemedies: delimiter-split approach for accurate field extraction */

var API='https://aravindkv28--ayurparam-service-fastapi-app.modal.run';
var $=function(id){return document.getElementById(id)};
var input=$('symptomInput'),btn=$('analyzeBtn'),loadEl=$('loading'),errEl=$('error');
var nerStrip=$('nerStrip'),matchBanner=$('matchBanner'),diseaseHeader=$('diseaseHeader');
var resultsEl=$('results'),disclaimer=$('disclaimerFooter');
var SVG='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>';

fetch(API+'/warmup').catch(function(){});
input.addEventListener('input',function(){btn.disabled=!input.value.trim()});
input.addEventListener('keypress',function(e){if(e.key==='Enter'&&!btn.disabled){e.preventDefault();doAnalyze()}});
btn.addEventListener('click',doAnalyze);
$('examples').addEventListener('click',function(e){if(e.target.classList.contains('example-btn')){input.value=e.target.dataset.value||'';btn.disabled=false;input.focus()}});

/* ‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê */
function esc(s){if(s==null)return '';var d=document.createElement('div');d.textContent=String(s);return d.innerHTML}
function empty(t){if(!t||typeof t!=='string')return true;var s=t.trim();if(s.length<5)return true;return /^(not provided|not available|not mentioned|no information|not given|not specified|not found|no data|none available|cannot be determined|n\/a)$/i.test(s)}
function stripMd(s){return s?s.replace(/\*\*/g,'').replace(/\*/g,'').trim():''}

/* ‚ïê‚ïê‚ïê FMT v7.4 ‚Äî Full markdown ‚Üí HTML renderer ‚ïê‚ïê‚ïê */
function fmt(text){
  if(!text)return '';
  var lines=text.split('\n');
  var html='';
  for(var i=0;i<lines.length;i++){
    var line=lines[i];
    if(/^---+\s*$/.test(line.trim())){html+='<hr class="fmt-hr">';continue}
    var h3=line.match(/^###\s+(.+)/);
    if(h3){html+='<span class="fmt-h3">'+inlineFmt(h3[1])+'</span>';continue}
    var h2=line.match(/^##\s+(.+)/);
    if(h2){html+='<span class="fmt-h2">'+inlineFmt(h2[1])+'</span>';continue}
    var bullet=line.match(/^[\-\u2022\u25B8]\s+(.+)/);
    if(bullet){html+='<div class="fmt-bullet"><span class="fmt-bullet-dot">‚ñ∏</span><span>'+inlineFmt(bullet[1])+'</span></div>';continue}
    var numbered=line.match(/^\d{1,2}[.)]\s+(.+)/);
    if(numbered){html+='<div class="fmt-bullet"><span class="fmt-bullet-dot" style="color:var(--amber)">‚Ä¢</span><span>'+inlineFmt(numbered[1])+'</span></div>';continue}
    if(line.trim()===''){html+='<div style="height:6px"></div>';continue}
    html+=inlineFmt(line)+'<br>';
  }
  html=html.replace(/(<br>\s*)+$/,'');
  return html;
}

function inlineFmt(text){
  if(!text)return '';
  var s=esc(text);
  s=s.replace(/\*\*([^*]+?)\*\*/g,'<strong class="fmt-bold">$1</strong>');
  s=s.replace(/\*([^*]+?)\*/g,'<em class="fmt-em">$1</em>');
  s=s.replace(/`([^`]+?)`/g,'<code style="background:var(--bg-warm);padding:1px 5px;border-radius:4px;font-size:12px;color:var(--terra)">$1</code>');
  return s;
}

function splitInlineNumbered(text){
  if(!text)return [];
  var positions=[];
  var rx=/(?:^|[\s,;.])\((\d{1,2})\)\s*|(?:^|[\s,;.])(\d{1,2})\)\s*|(?:^|[.\s])(\d{1,2})\.\s+(?=[A-Z*])/g;
  var m;
  while((m=rx.exec(text))!==null){positions.push({pos:m.index,len:m[0].length})}
  if(positions.length<2)return [];
  var items=[];
  if(positions[0].pos>10){var pre=text.substring(0,positions[0].pos).trim();if(pre.length>10)items.push({text:stripMd(pre),isPreamble:true})}
  for(var i=0;i<positions.length;i++){
    var start=positions[i].pos+positions[i].len;
    var end=i+1<positions.length?positions[i+1].pos:text.length;
    var chunk=text.substring(start,end).trim().replace(/[,;]\s*$/,'');
    if(chunk.length>2)items.push({text:stripMd(chunk)});
  }
  return items;
}

function smartExtract(text,minLen){
  if(!text||empty(text))return [];
  minLen=minLen||4;
  var numbered=splitInlineNumbered(text);
  if(numbered.length>=2)return numbered.filter(function(n){return !n.isPreamble}).map(function(n){return n.text}).filter(function(s){return s.length>=minLen&&s.length<150});
  var commaItems=text.split(/,\s*/).map(function(s){return stripMd(s.replace(/^[\s\-\u2022*\u25B8\d.\)]+/,'').replace(/\.\s*$/,'')).trim()}).filter(function(s){return s.length>=3&&s.length<80});
  var isRealList=commaItems.length>=3&&commaItems.every(function(s){return s.split(/\s+/).length<=4&&!/^and\s/i.test(s)&&s.indexOf('.')<0});
  if(isRealList)return commaItems.filter(function(s){return s.length>=minLen});
  return text.split(/(?<=[.!?;])\s+/).map(function(s){return stripMd(s.replace(/^[\s\-\u2022*\u25B8\d.\)]+/,'')).trim()}).filter(function(s){return s.length>=minLen&&s.length<200});
}

function isProse(text){
  if(!text)return true;
  var sents=text.split(/(?<=[.!?])\s+/).filter(function(s){return s.trim().length>5});
  if(sents.length<=2)return true;
  var avgLen=sents.reduce(function(a,s){return a+s.length},0)/sents.length;
  return avgLen>60;
}

function dedup(items){
  var seen={};var result=[];
  for(var i=0;i<items.length;i++){
    var key=items[i].toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
    var prefix=key.substring(0,25);
    if(seen[key]||seen[prefix])continue;
    seen[key]=true;seen[prefix]=true;result.push(items[i]);
  }
  return result;
}

function cleanRepetition(text){
  if(!text||text.length<50)return text;
  var chunks=text.split(/[,;]\s*/).map(function(s){return s.trim()}).filter(function(s){return s.length>0});
  if(chunks.length<5)return text;
  var freq={};var maxCount=0;
  for(var i=0;i<chunks.length;i++){
    var norm=chunks[i].toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();
    if(norm.length<2)continue;
    freq[norm]=(freq[norm]||0)+1;
    if(freq[norm]>maxCount)maxCount=freq[norm];
  }
  if(maxCount>4){
    var seen2={};var cleaned=[];var dupCount=0;
    for(var j=0;j<chunks.length;j++){
      var n2=chunks[j].toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();
      if(seen2[n2]){dupCount++;if(dupCount>2)continue}else{seen2[n2]=true;dupCount=0}
      cleaned.push(chunks[j]);
    }
    return cleaned.join(', ').trim().replace(/,\s*$/,'')+'.'
  }
  return text;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OTTAMOOLI PARSER v7.4
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   STRATEGY: Split each remedy block on " ‚Äî " delimiter, then map
   each segment to a field by its label prefix.

   LLM format:
     1. **Ashwagandha** ‚Äî Sanskrit: Withania somnifera ‚Äî Part Used: Root
        ‚Äî Preparation: Powder mixed with warm milk (3g) ‚Äî Dosage: 3g
        twice daily ‚Äî Duration: 4‚Äì6 weeks

   This avoids the old regex-lookahead approach that broke when
   parentheses contained numbers or lowercase text (e.g. "(10 ml)").
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function parseRemedies(rawText){
  if(!rawText||empty(rawText))return [];

  // Split into per-remedy blocks on numbered list markers
  var blocks=[];
  // Try newline-based numbered split first
  var nlBlocks=rawText.split(/\n(?=\d+[\.\)]\s)/);
  if(nlBlocks.length>=2){
    blocks=nlBlocks;
  } else {
    // Try bold-marker split: "1. **Name**"
    var boldBlocks=rawText.split(/(?=\d+[\.\)]\s*\*\*)/);
    if(boldBlocks.length>=2){blocks=boldBlocks}
    else{blocks=[rawText]}
  }

  var results=[];

  for(var bi=0;bi<blocks.length;bi++){
    var block=blocks[bi].trim();
    if(!block||block.length<8)continue;

    // Remove leading number+dot/paren
    block=block.replace(/^\d+[\.\)]\s*/,'');

    var entry={name:'',sanskrit:'',part:'',preparation:'',dosage:'',duration:'',actions:''};

    // ‚îÄ‚îÄ Extract name from **bold** ‚îÄ‚îÄ
    var boldM=block.match(/^\*\*([^*]+)\*\*/);
    if(boldM){
      entry.name=boldM[1].trim();
      block=block.substring(boldM[0].length).trim();
    } else {
      // Fallback: name is everything before the first " ‚Äî " or ":"
      var dashIdx=block.indexOf(' \u2014 ');
      if(dashIdx<0)dashIdx=block.indexOf(' ‚Äî ');
      if(dashIdx>0&&dashIdx<60){entry.name=stripMd(block.substring(0,dashIdx).trim());block=block.substring(dashIdx).trim()}
      else{var colonIdx=block.indexOf(':');if(colonIdx>0&&colonIdx<60){entry.name=stripMd(block.substring(0,colonIdx).trim());block=block.substring(colonIdx+1).trim()}}
    }

    // ‚îÄ‚îÄ Split remainder on " ‚Äî " delimiter ‚îÄ‚îÄ
    // Normalise various dash types to plain " ‚Äî "
    var remainder=block.replace(/\s*[\u2013\u2014]\s*/g,' ‚Äî ').replace(/\s+‚Äî\s+/g,' ‚Äî ');
    var segments=remainder.split(' ‚Äî ').map(function(s){return s.trim()}).filter(function(s){return s.length>0});

    for(var si=0;si<segments.length;si++){
      var seg=segments[si];

      // Each segment is "Label: value" or just a value
      var colonPos=seg.indexOf(':');
      if(colonPos<=0){
        // No label ‚Äî treat as description if nothing else set
        if(!entry.actions&&seg.length>5)entry.actions=stripMd(seg);
        continue;
      }

      var label=seg.substring(0,colonPos).trim().toLowerCase();
      var value=seg.substring(colonPos+1).trim();

      // Some labels may have trailing punctuation from parsing
      if(/sanskrit/.test(label))         entry.sanskrit   = stripMd(value);
      else if(/part\s*used|part/.test(label)) entry.part  = stripMd(value);
      else if(/preparation|prep/.test(label)) entry.preparation = stripMd(value);
      else if(/dos(?:age|e)/.test(label)) entry.dosage    = stripMd(value);
      else if(/duration/.test(label))     entry.duration   = stripMd(value);
      else if(/action|effect/.test(label))entry.actions   = stripMd(value);
    }

    // Clean up any accidental "Preparation: X" bleeding into part field
    if(entry.part&&/preparation/i.test(entry.part)){
      var prepM=entry.part.match(/^([^‚Äî\-:]+?)\s*(?:‚Äî|\-|Preparation)/i);
      if(prepM)entry.part=prepM[1].trim();
      else entry.part='';
    }

    if(entry.name||entry.part||entry.dosage)results.push(entry);
  }

  return results;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FORMULATION PARSER v7.4
   Same delimiter-split strategy applied to classical formulations.
   LLM format:
     1. **Chyawanprash** ‚Äî Form: Avaleha ‚Äî Dosage: 10‚Äì20g daily
        with warm milk ‚Äî Reference: Charaka Samhita
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function parseFormulations(rawText){
  if(!rawText||empty(rawText))return [];

  var blocks=[];
  var nlBlocks=rawText.split(/\n(?=\d+[\.\)]\s)/);
  if(nlBlocks.length>=2){blocks=nlBlocks}
  else{var boldBlocks=rawText.split(/(?=\d+[\.\)]\s*\*\*)/);if(boldBlocks.length>=2){blocks=boldBlocks}else{blocks=[rawText]}}

  // Filter out pure preamble blocks (no bold name or very short)
  blocks=blocks.filter(function(b){
    var t=b.replace(/^\d+[\.\)]\s*/,'').trim();
    return t.length>10&&!/^here\s+are/i.test(t)&&!/^the\s+following/i.test(t);
  });

  var results=[];

  for(var bi=0;bi<blocks.length;bi++){
    var block=blocks[bi].trim().replace(/^\d+[\.\)]\s*/,'');
    if(!block||block.length<8)continue;

    var entry={name:'',form:'',dose:'',reference:'',contains:'',cleanDesc:''};

    // Extract name
    var boldM=block.match(/^\*\*([^*]+)\*\*/);
    if(boldM){entry.name=boldM[1].trim();block=block.substring(boldM[0].length).trim()}
    else{
      var dashIdx=block.indexOf(' ‚Äî ');
      if(dashIdx<0)dashIdx=block.indexOf(' \u2014 ');
      if(dashIdx>0&&dashIdx<70){entry.name=stripMd(block.substring(0,dashIdx).trim());block=block.substring(dashIdx).trim()}
    }

    // Normalise and split on " ‚Äî "
    var remainder=block.replace(/\s*[\u2013\u2014]\s*/g,' ‚Äî ').replace(/\s+‚Äî\s+/g,' ‚Äî ');
    var segments=remainder.split(' ‚Äî ').map(function(s){return s.trim()}).filter(function(s){return s.length>0});

    var descParts=[];
    for(var si=0;si<segments.length;si++){
      var seg=segments[si];
      var colonPos=seg.indexOf(':');
      if(colonPos<=0){descParts.push(stripMd(seg));continue}
      var label=seg.substring(0,colonPos).trim().toLowerCase();
      var value=seg.substring(colonPos+1).trim();
      if(/form/.test(label))            entry.form=stripMd(value);
      else if(/dos(?:age|e)/.test(label)) entry.dose=stripMd(value);
      else if(/ref(?:erence)?/.test(label)) entry.reference=stripMd(value);
      else if(/contains?/.test(label))  entry.contains=stripMd(value);
      else descParts.push(stripMd(seg));
    }
    entry.cleanDesc=descParts.join('. ').replace(/\s{2,}/g,' ').trim();

    if(entry.name||entry.dose)results.push(entry);
  }

  return results;
}

function parseModernCorrelation(text){
  if(!text)return {correlation:'',treatment:'',treatmentItems:[],warnings:'',warningItems:[]};
  var result={correlation:'',treatment:'',treatmentItems:[],warnings:'',warningItems:[]};
  var numbered=splitInlineNumbered(text);
  if(numbered.length>=2){
    var parts=numbered.filter(function(n){return !n.isPreamble}).map(function(n){return n.text});
    for(var i=0;i<parts.length;i++){
      var low=parts[i].toLowerCase();
      if(low.match(/modern\s+medical\s+correlation|modern\s+correlation|equivalent/i)&&!result.correlation)result.correlation=parts[i];
      else if(low.match(/general\s+line|line\s+of\s+treatment|treatment\s+in\s+modern/i)&&!result.treatment)result.treatment=parts[i];
      else if(low.match(/danger\s+sign|red\s*flag|warning|immediate\s+(?:medical\s+)?attention/i))result.warnings=parts[i];
      else if(!result.correlation)result.correlation=parts[i];
      else if(!result.treatment)result.treatment=parts[i];
      else result.warnings=(result.warnings?result.warnings+' ':'')+parts[i];
    }
  }else{
    var corrEnd=text.search(/(?:general\s+line|line\s+of\s+treatment|treatment\s+in\s+modern)/i);
    var warnStart=text.search(/(?:danger\s+sign|red\s*flag|warning|immediate\s+(?:medical\s+)?attention)/i);
    if(corrEnd>0&&warnStart>corrEnd){result.correlation=text.substring(0,corrEnd).trim();result.treatment=text.substring(corrEnd,warnStart).trim();result.warnings=text.substring(warnStart).trim()}
    else if(corrEnd>0){result.correlation=text.substring(0,corrEnd).trim();result.treatment=text.substring(corrEnd).trim()}
    else{result.correlation=text}
  }
  if(result.treatment){
    var tItems=result.treatment.split(/\s*[\-\u2013]\s+(?=[A-Z])/).filter(function(s){return s.trim().length>5});
    if(tItems.length>=2){
      var intro=tItems[0];var incIdx=intro.search(/includes?\s*:\s*/i);
      if(incIdx>=0){result.treatment=intro.substring(0,incIdx+('includes:'.length)).trim();tItems[0]=intro.substring(incIdx+('includes:'.length)).trim()}
      else{result.treatment=intro;tItems.shift()}
      result.treatmentItems=tItems.map(function(s){return stripMd(s).replace(/\.\s*$/,'').trim()}).filter(function(s){return s.length>3});
    }
  }
  if(result.warnings){
    var wItems=result.warnings.split(/\s*[\-\u2013]\s+(?=[A-Z])/).filter(function(s){return s.trim().length>5});
    if(wItems.length>=2){result.warnings=wItems[0];wItems.shift();result.warningItems=wItems.map(function(s){return stripMd(s).replace(/\.\s*$/,'').trim()}).filter(function(s){return s.length>3})}
  }
  if(result.warningItems.length>0)result.warningItems=dedup(result.warningItems);
  result.correlation=result.correlation.replace(/^(?:The\s+)?modern\s+(?:medical\s+)?correlation\s+(?:for\s+\w+\s+)?(?:is|includes?)\s*/i,'').trim();
  result.treatment=result.treatment.replace(/^(?:The\s+)?general\s+line\s+of\s+treatment\s+(?:in\s+modern\s+medicine\s+)?(?:for\s+\w+\s+)?(?:includes?)\s*:?\s*/i,'').trim();
  result.warnings=result.warnings.replace(/^(?:Danger\s+signs?\s*(?:or\s+red\s*flags?\s*)?(?:requiring|needing)\s+immediate\s+(?:medical\s+)?attention\s*(?:include)?\s*:?\s*)/i,'').trim();
  return result;
}

/* ‚ïê‚ïê‚ïê ANALYZE ‚ïê‚ïê‚ïê */
async function doAnalyze(){
  var text=input.value.trim();if(!text)return;
  btn.disabled=true;btn.innerHTML=SVG+' Analyzing...';
  loadEl.classList.remove('hidden');errEl.classList.add('hidden');
  [nerStrip,matchBanner,diseaseHeader,resultsEl,disclaimer].forEach(function(e){e.classList.add('hidden')});
  resultsEl.innerHTML='';
  var ctrl=new AbortController(),tout=setTimeout(function(){ctrl.abort()},180000);
  try{
    var res=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text}),signal:ctrl.signal});
    clearTimeout(tout);if(!res.ok)throw new Error('HTTP '+res.status);
    var data=await res.json();console.log('API:',JSON.stringify(data,null,2));render(data,text);
  }catch(err){
    console.error(err);errEl.textContent='\u26A0\uFE0F '+(err.name==='AbortError'?'Request timed out. Please try again.':err.message.includes('fetch')?'Network error.':err.message);errEl.classList.remove('hidden');
  }finally{btn.disabled=false;btn.innerHTML=SVG+' Analyze';loadEl.classList.add('hidden');btn.disabled=!input.value.trim()}
}

/* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
function render(data,origSym){
  var tx=null;
  if(data.results&&data.results.length)tx=data.results[0].treatment_info;
  else if(data.treatment_info)tx=data.treatment_info;
  if(!tx){errEl.textContent='No treatment info.';errEl.classList.remove('hidden');return}
  var R=tx.ayurparam_responses||{},csv=data.csv_match||null;
  console.log('Response keys:',Object.keys(R));
  [nerStrip,matchBanner,diseaseHeader,resultsEl,disclaimer].forEach(function(e){e.classList.remove('hidden')});

  // NER strip
  nerStrip.innerHTML='<span class="ner-strip-label">Detected Entities</span>';
  var ents=data.clinical_entities;
  if(ents&&ents.length){ents.forEach(function(e){var t=document.createElement('span');t.className='ner-tag';t.innerHTML=esc(e.word)+' <span class="score">'+esc(e.entity_group||'ENTITY')+' \u00B7 '+Math.round((e.score||.9)*100)+'%</span>';nerStrip.appendChild(t)})}
  else{var t=document.createElement('span');t.className='ner-tag';t.innerHTML=esc(origSym)+' <span class="score">ENTITY \u00B7 98%</span>';nerStrip.appendChild(t)}

  var cond=tx.condition_name||(csv&&csv.ayurveda_term)||origSym;
  $('matchDetails').textContent='Detected: '+origSym+' \u2192 '+cond;
  $('matchPercent').textContent=csv?'100%':'SNOMED';
  $('itaCode').textContent=(csv&&csv.ita_id)||'ITA';
  $('diseaseName').textContent=cond;
  $('sanskritName').textContent=tx.sanskrit_name||(csv&&csv.sanskrit_iast)||(csv&&csv.sanskrit)||'';

  // Dosha dots
  var oLow=((R.overview_dosha_causes||'')+' '+cond).toLowerCase();
  var dh='';
  if(/v[a\u0101]t/i.test(oLow))dh+='<span class="dosha-dot vata"></span>';
  if(/pitt/i.test(oLow))dh+='<span class="dosha-dot pitta"></span>';
  if(/kaph/i.test(oLow))dh+='<span class="dosha-dot kapha"></span>';
  if(!dh)dh='<span class="dosha-dot vata"></span><span class="dosha-dot pitta"></span><span class="dosha-dot kapha"></span>';
  dh+='<span class="dosha-text">Dosha imbalance \u2014 requires assessment</span>';
  $('doshaLine').innerHTML=dh;

  // SNOMED + ICD-10
  var snomed=data.snomed_code||(data.results&&data.results[0]&&data.results[0].snomed_code)||'';
  var hasSNOMED=snomed&&snomed!=='N/A'&&snomed!=='00000000'&&snomed.length>1;
  $('snomedRow').style.display=hasSNOMED?'flex':'none';
  if(hasSNOMED){$('snomedCode').textContent=snomed;$('snomedName').textContent=data.snomed_name||cond}
  var icd10=data.icd10_code||(data.results&&data.results[0]&&data.results[0].icd10_code)||'';
  var hasICD=icd10&&icd10!=='N/A'&&icd10.length>1;
  $('icdRow').style.display=hasICD?'flex':'none';
  if(hasICD)$('icdCode').textContent=icd10;

  var H='';

  // ‚ïê‚ïê‚ïê 1. DISEASE DESCRIPTION ‚ïê‚ïê‚ïê
  if(!empty(R.overview_dosha_causes)){
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon green">üìã</div><span class="sc-title">Disease Description</span></div>';
    H+='<div class="desc-text">'+fmt(R.overview_dosha_causes)+'</div>';
    if(csv&&csv.description)H+='<div style="margin-top:10px;font-size:13px;color:var(--text-light);background:var(--bg-warm);padding:6px 14px;border-radius:8px">üè• '+esc(csv.description)+'</div>';
    H+='</div>';
  }

  // ‚ïê‚ïê‚ïê 2. NIDANA + SYMPTOMS ‚ïê‚ïê‚ïê
  var nidText='';
  if(!empty(R.overview_dosha_causes)){
    var sentences=R.overview_dosha_causes.split(/(?<=[.!?])\s+/);
    var nidSentences=[];
    for(var si=0;si<sentences.length;si++){if(/nid[a\u0101]na|causes?\b|etiolog|provocat|aggravat/i.test(sentences[si]))nidSentences.push(sentences[si])}
    nidText=nidSentences.join(' ').trim();
    if(!nidText&&sentences.length>1)nidText=sentences[sentences.length-1].trim();
  }

  var sympHTML='';
  if(!empty(R.symptoms)){
    var raw=R.symptoms;
    var isMetaSentence=function(s){return /^these\s+(indicate|signs?|symptoms?|reflect|arise|are\s+due|manifest)/i.test(s.trim())};
    var numbered2=splitInlineNumbered(raw);
    if(numbered2.length>=3){
      var items=dedup(numbered2.filter(function(n){return !n.isPreamble}).map(function(n){return n.text})).filter(function(s){return !isMetaSentence(s)}).slice(0,12);
      var preamble=numbered2.filter(function(n){return n.isPreamble})[0];
      if(preamble&&preamble.text.length>15&&!isMetaSentence(preamble.text))sympHTML+='<div class="desc-text" style="margin-bottom:12px">'+fmt(preamble.text)+'</div>';
      if(items.length>0)sympHTML+='<div class="tag-list">'+items.map(function(s){return '<span class="tag-symptom">'+esc(s)+'</span>'}).join('')+'</div>';
      else sympHTML='<div class="desc-text">'+fmt(raw)+'</div>';
    }else{
      var sents=raw.split(/(?<=[.!?])\s+/).filter(function(s){return s.trim().length>5});
      var realSents=sents.filter(function(s){return !isMetaSentence(s)});
      if(realSents.length<=3||isProse(raw)){sympHTML='<div class="desc-text">'+fmt(raw)+'</div>'}
      else{
        var items2=dedup(realSents.map(function(s){return stripMd(s).trim()})).filter(function(s){return s.length>4&&s.length<150}).slice(0,12);
        sympHTML='<div class="tag-list">'+items2.map(function(s){return '<span class="tag-symptom">'+esc(s)+'</span>'}).join('')+'</div>';
      }
    }
  }

  var hasNid=nidText.length>10,hasSym=sympHTML.length>0;
  var useTwoCol=hasNid&&hasSym&&nidText.length>80;
  if(useTwoCol){
    H+='<div class="two-col fade-in">';
    H+='<div class="sc" style="margin-bottom:0"><div class="sc-head"><div class="sc-icon amber">üîç</div><span class="sc-title">Root Causes (NidƒÅna)</span></div><div class="desc-text">'+fmt(nidText)+'</div></div>';
    H+='<div class="sc" style="margin-bottom:0"><div class="sc-head"><div class="sc-icon terra">ü©∫</div><span class="sc-title">Symptoms (R≈´pa)</span></div>'+sympHTML+'</div>';
    H+='</div>';
  }else{
    if(hasNid)H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon amber">üîç</div><span class="sc-title">Root Causes (NidƒÅna)</span></div><div class="desc-text">'+fmt(nidText)+'</div></div>';
    if(hasSym)H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon terra">ü©∫</div><span class="sc-title">Symptoms (R≈´pa)</span></div>'+sympHTML+'</div>';
  }

  // ‚ïê‚ïê‚ïê 3. OTTAMOOLI ‚ïê‚ïê‚ïê
  if(!empty(R.single_drug_remedies)){
    var remedies=parseRemedies(R.single_drug_remedies);
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon green">üåø</div><span class="sc-title">Ottamooli ‚Äî Single Medicine Remedies</span></div><div class="remedy-grid">';
    if(remedies.length>0){
      remedies.forEach(function(r){
        H+='<div class="remedy-card">';
        H+='<div class="remedy-name">'+esc(r.name||'Herbal Remedy')+'</div>';
        if(r.sanskrit)H+='<div class="remedy-sanskrit">'+esc(r.sanskrit)+'</div>';
        H+='<div class="remedy-fields">';
        if(r.part)       H+='<div class="rf"><span class="rf-label">Part Used</span>'+esc(r.part)+'</div>';
        if(r.preparation)H+='<div class="rf"><span class="rf-label">Preparation</span>'+esc(r.preparation)+'</div>';
        if(r.dosage)     H+='<div class="rf"><span class="rf-label">Dosage</span>'+esc(r.dosage)+'</div>';
        if(r.duration)   H+='<div class="rf"><span class="rf-label">Duration</span>'+esc(r.duration)+'</div>';
        if(r.actions)    H+='<div class="rf" style="grid-column:1/-1"><span class="rf-label">Actions / Effect</span>'+esc(r.actions)+'</div>';
        H+='</div></div>';
      });
    } else {
      H+='<div class="desc-text" style="padding:4px">'+fmt(R.single_drug_remedies)+'</div>';
    }
    H+='</div></div>';
  }

  // ‚ïê‚ïê‚ïê 4. CLASSICAL FORMULATIONS ‚ïê‚ïê‚ïê
  if(!empty(R.classical_formulations)){
    var formulations=parseFormulations(R.classical_formulations);
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon amber">üíä</div><span class="sc-title">Classical Formulations (Yogas)</span></div><div class="remedy-grid">';
    if(formulations.length>0){
      formulations.forEach(function(f){
        H+='<div class="form-card"><h4>'+esc(f.name||'Classical Formulation')+'</h4>';
        if(f.cleanDesc&&f.cleanDesc.length>10)H+='<div class="form-desc">'+fmt(f.cleanDesc)+'</div>';
        H+='<div class="form-meta">';
        if(f.dose)    H+='<span>üíä <strong>Dose:</strong> '+esc(f.dose)+'</span>';
        if(f.form)    H+='<span>üì¶ <strong>Form:</strong> '+esc(f.form)+'</span>';
        if(f.contains)H+='<span>üß™ <strong>Contains:</strong> '+esc(f.contains)+'</span>';
        H+='</div>';
        if(f.reference)H+='<div class="ref-badge">üìñ '+esc(f.reference)+'</div>';
        H+='</div>';
      });
    } else {
      H+='<div class="desc-text" style="padding:4px">'+fmt(R.classical_formulations)+'</div>';
    }
    H+='</div></div>';
  }

  // ‚ïê‚ïê‚ïê 5. PANCHAKARMA ‚ïê‚ïê‚ïê
  if(!empty(R.panchakarma)){
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon amber">üõÅ</div><span class="sc-title">Panchakarma Therapies</span></div>';
    H+='<div class="pk-card"><div class="desc-text">'+fmt(R.panchakarma)+'</div></div></div>';
  }

  // ‚ïê‚ïê‚ïê 6. DIET & LIFESTYLE ‚ïê‚ïê‚ïê
  if(!empty(R.diet_lifestyle)){
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon green">ü•ó</div><span class="sc-title">Diet & Lifestyle (Pathya-Apathya)</span></div>';
    H+='<div class="desc-text">'+fmt(R.diet_lifestyle)+'</div>';
    H+='<div class="diet-note" style="margin-top:12px">üí° Follow dietary guidelines suited to your prak·πõti. Consult an Ayurvedic practitioner.</div>';
    H+='</div>';
  }

  // ‚ïê‚ïê‚ïê 7. YOGA ‚ïê‚ïê‚ïê
  if(!empty(R.yoga)){
    var yogaRaw=cleanRepetition(R.yoga);
    var yogaNumbered=splitInlineNumbered(yogaRaw);
    var yogaItems=[];
    if(yogaNumbered.length>=2){yogaItems=dedup(yogaNumbered.filter(function(n){return !n.isPreamble}).map(function(n){return n.text})).slice(0,10)}
    if(yogaItems.length===0){var commaSplit=yogaRaw.split(/,\s*(?=\d+\.\s)/).map(function(s){return stripMd(s).trim()}).filter(function(s){return s.length>3});yogaItems=dedup(commaSplit).slice(0,10)}
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon green">üßò</div><span class="sc-title">Yoga & PrƒÅ·πáƒÅyƒÅma</span></div>';
    if(yogaItems.length>=2){H+='<div class="yoga-grid">'+yogaItems.map(function(i){return '<span class="yoga-tag">'+esc(i)+'</span>'}).join('')+'</div>'}
    else{H+='<div class="desc-text">'+fmt(yogaRaw)+'</div>'}
    H+='</div>';
  }

  // ‚ïê‚ïê‚ïê 8. PROGNOSIS ‚ïê‚ïê‚ïê
  if(!empty(R.prognosis)){
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon green">üìà</div><span class="sc-title">Prognosis (SƒÅdhya / YƒÅpya / AsƒÅdhya)</span></div>';
    H+='<div class="prog-box">'+fmt(R.prognosis)+'</div></div>';
  }

  // ‚ïê‚ïê‚ïê 9. MODERN MEDICAL CORRELATION ‚ïê‚ïê‚ïê
  if(!empty(R.modern_correlation_warnings)){
    var mc=parseModernCorrelation(R.modern_correlation_warnings);
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon blue">üè•</div><span class="sc-title">Modern Medical Correlation & Treatment</span></div>';
    H+='<div class="modern-section">';
    if(mc.correlation&&mc.correlation.length>5){H+='<div class="modern-sub">üè• Modern Medical Correlation</div><div class="desc-text">'+fmt(mc.correlation)+'</div>'}
    if((mc.treatment&&mc.treatment.length>5)||mc.treatmentItems.length>0){
      H+='<div class="modern-sub">üíä General Line of Treatment in Modern Medicine</div>';
      if(mc.treatment&&mc.treatment.length>5)H+='<div class="desc-text" style="margin-bottom:6px">'+fmt(mc.treatment)+'</div>';
      if(mc.treatmentItems.length>0){H+='<ul>';mc.treatmentItems.forEach(function(item){H+='<li>'+esc(item)+'</li>'});H+='</ul>'}
    }
    if((!mc.correlation||mc.correlation.length<=5)&&(!mc.treatment||mc.treatment.length<=5)&&mc.treatmentItems.length===0){H+='<div class="desc-text">'+fmt(R.modern_correlation_warnings)+'</div>'}
    H+='</div></div>';
    if((mc.warnings&&mc.warnings.length>5)||mc.warningItems.length>0){
      H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon red">‚ö†Ô∏è</div><span class="sc-title">Warning Signs & Red Flags</span></div>';
      if(mc.warningItems.length>0){H+='<div class="scroll-box"><div class="warn-list">';mc.warningItems.forEach(function(w){H+='<div class="warn-item"><div class="warn-icon">!</div><span>'+esc(w)+'</span></div>'});H+='</div></div>'}
      else{H+='<div class="desc-text">'+fmt(mc.warnings)+'</div>'}
      H+='</div>';
    }
  }

  // ‚ïê‚ïê‚ïê 10. DIFFERENTIAL DIAGNOSIS ‚ïê‚ïê‚ïê
  if(!empty(R.differential_diagnosis)){
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon blue">ü©∫</div><span class="sc-title">Differential Diagnosis (Vyavachedaka NidƒÅna)</span></div>';
    var ddNumbered=splitInlineNumbered(R.differential_diagnosis);
    var ddItems=ddNumbered.length>=2?ddNumbered.filter(function(n){return !n.isPreamble}).map(function(n){return n.text}):[];
    var ddPreamble=ddNumbered.filter(function(n){return n.isPreamble})[0];
    if(ddItems.length>=2){
      if(ddPreamble&&ddPreamble.text.length>10)H+='<div class="desc-text" style="margin-bottom:12px">'+fmt(ddPreamble.text)+'</div>';
      H+='<div class="scroll-box"><div class="dd-grid">';
      ddItems.forEach(function(item){
        var dashSplit=item.match(/^(.+?)\s*[\u2014\u2013\-]{1,2}\s*(.+)$/);
        if(dashSplit){H+='<div class="dd-item"><div class="dd-name">'+esc(stripMd(dashSplit[1]))+'</div><div class="dd-detail">'+esc(stripMd(dashSplit[2]))+'</div></div>'}
        else{H+='<div class="dd-item"><div class="dd-name">'+esc(stripMd(item))+'</div></div>'}
      });
      H+='</div></div>';
    }else{H+='<div class="diff-card"><div class="desc-text">'+fmt(R.differential_diagnosis)+'</div></div>'}
    H+='</div>';
  }

  // ‚ïê‚ïê‚ïê 11. INVESTIGATIONS ‚ïê‚ïê‚ïê
  if(!empty(R.investigations_labs)){
    var invRaw=cleanRepetition(R.investigations_labs);
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon amber">üß™</div><span class="sc-title">Investigations & Laboratory Tests</span></div>';
    var invNumbered=splitInlineNumbered(invRaw);
    var invItems=invNumbered.length>=2?invNumbered.filter(function(n){return !n.isPreamble}).map(function(n){return n.text}):[];
    var invPreamble=invNumbered.filter(function(n){return n.isPreamble})[0];
    if(invItems.length>=2){
      if(invPreamble&&invPreamble.text.length>10)H+='<div class="desc-text" style="margin-bottom:12px">'+fmt(invPreamble.text)+'</div>';
      H+='<div class="scroll-box"><div class="invest-grid">';
      dedup(invItems).slice(0,12).forEach(function(item){
        var dashSplit=item.match(/^(.+?)\s*[\u2014\u2013]{1}\s*(.+)$/)||item.match(/^(.+?)\s+\-\s+(.+)$/);
        if(dashSplit){H+='<div class="invest-item"><div class="invest-name">'+esc(stripMd(dashSplit[1]))+'</div><div class="invest-finding">'+esc(stripMd(dashSplit[2]))+'</div></div>'}
        else{H+='<div class="invest-item"><div class="invest-name">'+esc(stripMd(item))+'</div></div>'}
      });
      H+='</div></div>';
    }else{H+='<div class="scroll-box"><div class="invest-card"><div class="desc-text">'+fmt(invRaw)+'</div></div></div>'}
    H+='</div>';
  }

  // ‚ïê‚ïê‚ïê 12. PREVENTION ‚ïê‚ïê‚ïê
  if(!empty(R.prevention_recurrence)){
    var prevText=cleanRepetition(R.prevention_recurrence);
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon green">üõ°Ô∏è</div><span class="sc-title">Prevention & Non-Recurrence (Apunarbhava)</span></div>';
    H+='<div class="prev-card"><div class="desc-text">'+fmt(prevText)+'</div></div></div>';
  }

  // ‚ïê‚ïê‚ïê 13. PSYCHOTHERAPY ‚ïê‚ïê‚ïê
  if(!empty(R.psychotherapy_satvavajaya)){
    var psyText=cleanRepetition(R.psychotherapy_satvavajaya);
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon blue">üßò‚Äç‚ôÇÔ∏è</div><span class="sc-title">Psychotherapy (SƒÅtvavajƒÅya CikitsƒÅ)</span></div>';
    H+='<div class="psy-card"><div class="desc-text">'+fmt(psyText)+'</div></div></div>';
  }

  // ‚ïê‚ïê‚ïê BACKWARD COMPAT ‚ïê‚ïê‚ïê
  if(!empty(R.panchakarma_diet_lifestyle_yoga)&&empty(R.panchakarma)){
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon amber">üõÅ</div><span class="sc-title">Treatment Protocols</span></div><div class="desc-text">'+fmt(R.panchakarma_diet_lifestyle_yoga)+'</div></div>';
  }
  if(!empty(R.prognosis_modern_warnings)&&empty(R.prognosis)){
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon green">üìà</div><span class="sc-title">Prognosis & Clinical Notes</span></div><div class="prog-box">'+fmt(R.prognosis_modern_warnings)+'</div></div>';
  }

  // ‚ïê‚ïê‚ïê CATCH-ALL ‚ïê‚ïê‚ïê
  var done=['overview_dosha_causes','symptoms','single_drug_remedies','classical_formulations','panchakarma','diet_lifestyle','yoga','prognosis','modern_correlation_warnings','differential_diagnosis','investigations_labs','prevention_recurrence','psychotherapy_satvavajaya','panchakarma_diet_lifestyle_yoga','prognosis_modern_warnings'];
  Object.keys(R).forEach(function(k){
    if(done.indexOf(k)>=0||!R[k]||typeof R[k]!=='string'||empty(R[k]))return;
    H+='<div class="sc fade-in"><div class="sc-head"><div class="sc-icon amber">üìÑ</div><span class="sc-title">'+esc(k.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase()}))+'</span></div><div class="desc-text">'+fmt(R[k])+'</div></div>';
  });

  resultsEl.innerHTML=H;
}
</script></body></html>
